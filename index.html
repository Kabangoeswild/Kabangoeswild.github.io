
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR.js Multi-Marker Logger</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <a-scene embedded arjs>
      <a-marker preset="hiro" id="marker-hiro"></a-marker>
      <a-marker preset="kanji" id="marker-kanji"></a-marker>
      <a-entity camera></a-entity>
    </a-scene>

    <button id="downloadBtn" style="position: fixed; top: 10px; left: 10px; z-index: 999;">Download MultiMarker Datei</button>

    <script>
      const markers = {
        hiro: document.querySelector('#marker-hiro'),
        kanji: document.querySelector('#marker-kanji')
      };

      let baseMatrix = null;
      const subMarkers = [];

      function getPoseMatrix(obj3D) {
        const mat = new THREE.Matrix4();
        obj3D.updateMatrixWorld(true);
        mat.copy(obj3D.matrixWorld);
        return mat.toArray();
      }

      function inverseMatrix(matArray) {
        const mat = new THREE.Matrix4();
        mat.fromArray(matArray);
        return new THREE.Matrix4().getInverse(mat);
      }

      function multiplyMatrices(a, b) {
        const ma = new THREE.Matrix4().fromArray(a);
        const mb = new THREE.Matrix4().fromArray(b);
        return ma.multiply(mb).toArray();
      }

      function downloadJSON(obj, filename) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      document.getElementById('downloadBtn').addEventListener('click', () => {
        if (!baseMatrix) {
          alert('Warte auf Sichtbarkeit von Hiro Marker als Referenz.');
          return;
        }

        const multiMarkerData = {
          meta: {
            createdBy: 'AR.js Logger',
            createdAt: new Date().toISOString()
          },
          trackingBackend: 'artoolkit',
          subMarkersControls: subMarkers
        };

        downloadJSON(multiMarkerData, 'multi-marker.json');
      });

      setInterval(() => {
        const visible = Object.entries(markers).filter(([name, marker]) => marker.object3D.visible);

        if (visible.length === 0) return;

        for (const [name, marker] of visible) {
          const worldMatrix = getPoseMatrix(marker.object3D);

          if (name === 'hiro' && !baseMatrix) {
            baseMatrix = worldMatrix;
            console.log('Basis-Marker gesetzt: Hiro');
          }

          if (baseMatrix && !subMarkers.find(m => m.parameters.preset === name)) {
            const invBase = inverseMatrix(baseMatrix);
            const relativeMatrix = multiplyMatrices(invBase.toArray(), worldMatrix);

            subMarkers.push({
              parameters: {
                type: 'pattern',
                preset: name
              },
              poseMatrix: relativeMatrix
            });

            console.log(`Marker ${name} hinzugef√ºgt.`);
          }
        }
      }, 1000);
    </script>
  </body>
</html>
