<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR.js Video on Hiro Marker</title>
    <script src="aframe.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs='sourceType: webcam; trackingMethod: best;' renderer="alpha: true">
        <a-assets>
            <!-- Video assets -->
            <video id="video1" src="xz-notencoded_DSQzQjVL.mp4" crossorigin="anonymous" preload="auto" loop muted playsinline></video>
            <video id="video2" src="xz-rot-x-30-deg_Dqejoe8d.mp4" crossorigin="anonymous" preload="auto" loop muted playsinline></video>
            <video id="video3" src="yz-x_rukE9moh.mp4" crossorigin="anonymous" preload="auto" loop muted playsinline></video>
            <video id="video4" src="xz-rot-x-60-deg_LP2UAxuj.mp4" crossorigin="anonymous" preload="auto" loop muted playsinline></video>
            <video id="video5" src="yz-x-035_bQDTO1Mq.mp4" crossorigin="anonymous" preload="auto" loop muted playsinline></video>
            <video id="video6" src="yz-x0,35_ttixT4aA.mp4" crossorigin="anonymous" preload="auto" loop muted playsinline></video>
            <video id="video7" src="xz-rot-z-30-deg_VQ1Otf3Z.mp4" crossorigin="anonymous" preload="auto" loop muted playsinline></video>
        </a-assets>

        <a-marker preset="hiro">
            <!-- Video entities -->
            <a-video id="markerVideo1" autoplay loop="true" src="#video1" width="1" height="0.75" position="0 0 0.0" rotation="-90 0 0"
                material="transparent: true;  depthTest: false; blending: normal;" visible="true"></a-video>
            <a-video id="markerVideo2" autoplay loop="true" src="#video2" width="1" height="0.75" position="0 0 0" rotation="-30 0 0"
                material="transparent: true;  depthTest: false; blending: normal;" visible="true"></a-video>
            <a-video id="markerVideo3" autoplay loop="true" src="#video3" width="1" height="0.75" position="0 0 0" rotation="0 90 0"
                material="transparent: true; opacity: 0.8;" visible="true"></a-video>
            <a-video id="markerVideo4" autoplay loop="true" src="#video4" width="1" height="0.75" position="0 0 0" rotation="-60 0 0"
                material="transparent: true;  depthTest: false; blending: normal;" visible="true"></a-video>
            <a-video id="markerVideo5" autoplay loop="true" src="#video5" width="1" height="0.75" position="-0.5 0 0" rotation="0 90 0"
                material="transparent: true; opacity: 0.8;  depthTest: false; blending: normal;" visible="true"></a-video>
            <a-video id="markerVideo6" autoplay loop="true" src="#video6" width="1" height="0.75" position="0.5 0 0" rotation="0 90 0"
                material="transparent: true; opacity: 0.8;  depthTest: false; blending: normal;" visible="true"></a-video>
            <a-video id="markerVideo7" autoplay loop="true" src="#video7" width="1" height="0.75" position="0 0 0" rotation="-90 30 0"
                material="transparent: true; opacity: 0.8;  depthTest: false; blending: normal;" visible="true"></a-video>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        window.addEventListener('load', () => {
            const marker = document.querySelector('a-marker');
            const camera = document.querySelector('[camera]');

            // Videos
            const markerVideos = {
                video1: document.getElementById('markerVideo1'),
                video2: document.getElementById('markerVideo2'),
                video3: document.getElementById('markerVideo3'),
                video4: document.getElementById('markerVideo4'),
                video5: document.getElementById('markerVideo5'),
                video6: document.getElementById('markerVideo6'),
                video7: document.getElementById('markerVideo7'),
            };

            const videoElements = ['video1', 'video2', 'video3', 'video4', 'video5', 'video6'].map(id => document.getElementById(id));

            // Play all videos
            videoElements.forEach(video => playVideo(video));

            // Helper function to play video when ready
            function playVideo(video) {
                if (video.readyState >= 3) {
                    video.play();
                } else {
                    video.addEventListener('canplay', () => video.play(), { once: true });
                }
            }

            // Function to manage visibility and opacity of videos
            function updateVisibility(videosToShow = [], opacities = {}) {
                Object.keys(markerVideos).forEach(id => {
                    markerVideos[id].setAttribute('visible', videosToShow.includes(id) ? 'true' : 'false');
                    if (opacities[id]) {
                        markerVideos[id].setAttribute('material', 'opacity', opacities[id]);
                    }
                });
            }

            // Function to update video opacities based on distance
            function updateVideoOpacities(distance) {
                let opacity3 = 0.8, opacity5 = 0.2, opacity6 = 0.2;

                if (distance >= 2.5 && distance <= 3) {
                    opacity3 = 0.8 - ((distance - 2.5) * 0.4);
                } else if (distance < 2.5) {
                    opacity3 = 0.8;
                    opacity5 = 0.2 + (Math.min(2.5 - distance, 0.5) * 0.8);
                } else if (distance > 3) {
                    opacity6 = 0.2 + ((distance - 3) * 0.8);
                }

                return {
                    video3: Math.min(Math.max(opacity3, 0.2), 0.8),
                    video5: Math.min(Math.max(opacity5, 0.2), 0.8),
                    video6: Math.min(Math.max(opacity6, 0.2), 0.8),
                };
            }

            // Animation loop with requestAnimationFrame
            function updateScene() {
                const markerRotation = marker.object3D.rotation;
                const markerRotationX = markerRotation.x * THREE.MathUtils.RAD2DEG;
                const markerRotationY = markerRotation.y * THREE.MathUtils.RAD2DEG;
                const distance = marker.object3D.position.distanceTo(camera.object3D.position);

                console.log(`Distance to Marker: ${distance.toFixed(2)} meters`);
                console.log(`Marker Rotation X: ${markerRotationX.toFixed(2)}, Y: ${markerRotationY.toFixed(2)}`);

                let visibleVideos = [];
                let opacities = {};

                // Example: Handle visibility logic for Video 1, Video 4, etc.
                if (markerRotationX > 80 && markerRotationY > -20 && markerRotationY < 20) {
                    visibleVideos = ['video1'];
                } else if (markerRotationX <= 70 && markerRotationX > 50) {
                    visibleVideos = ['video4'];
                } else if (markerRotationX <= 40) {
                    visibleVideos = ['video2'];
                }

                // Handle distance-based logic for Video 3, 5, and 6
                opacities = updateVideoOpacities(distance);

                // Update visibility and opacities of videos
                updateVisibility(visibleVideos, opacities);

                // Continue the animation loop
                requestAnimationFrame(updateScene);
            }

            // When the marker is found
            marker.addEventListener('markerFound', () => {
                updateScene(); // Start animation when marker is found
            });

            // When the marker is lost
            marker.addEventListener('markerLost', () => {
                updateVisibility([]); // Hide all videos when marker is lost
            });
        });
    </script>
</body>
</html>

